<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Admin Panel</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="bootstrap5/css/bootstrap.min.css">

    <!-- Bootstrap JS -->
    <script src="bootstrap5/js/bootstrap.bundle.min.js"></script>
</head>

<body class="bg-light">

    <div class="container py-4">

        <h3 class="mb-4">Admin Panel â€“ Quiz Submissions</h3>

        <!-- LOGIN BUTTON -->
        <button id="loginBtn" class="btn btn-primary mb-3" onclick="login()">
            Login with Google
        </button>

        <!-- TABLE -->
        <div class="table-responsive" id="tableWrapper" style="display:none;">
            <table class="table table-bordered table-striped table-hover align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>#</th>
                        <th>Name</th>
                        <th>WhatsApp</th>
                        <th>Submitted At</th>
                        <th>Circle</th>
                        <th>Diamond</th>
                        <th>Rectangle</th>
                        <th>Square</th>
                        <th>Star</th>
                        <th>Triangle</th>
                    </tr>
                </thead>
                <tbody id="tbody"></tbody>
            </table>
        </div>

        <!-- EXPORT BUTTON -->
        <button id="exportBtn" onclick="exportCSV()" class="btn btn-success mt-3" style="display:none;">
            Export to CSV
        </button>

    </div>

    <!-- FIREBASE LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider }
            from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        import {
            getFirestore,
            collection,
            getDocs,
            doc,
            getDoc,
            query,
            orderBy
        } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        /* ---------- FIREBASE CONFIG ---------- */
        const firebaseConfig = {
            apiKey: "AIzaSyDrCQUE307cCB-RrmuA6ei7cnyW1NUv2f0",
            authDomain: "skills-test-b33c4.firebaseapp.com",
            projectId: "skills-test-b33c4",
            storageBucket: "skills-test-b33c4.firebasestorage.app",
            messagingSenderId: "132278071102",
            appId: "1:132278071102:web:bdb2f8949c5c6f8932c66f"
        };

        /* ---------- INIT ---------- */
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        /* ---------- LOGIN ---------- */
        window.login = async () => {
            try {
                const result = await signInWithPopup(auth, provider);
                const email = result.user.email;

                // Check admin access
                const adminRef = doc(db, "admins", email);
                const adminSnap = await getDoc(adminRef);

                if (!adminSnap.exists()) {
                    alert("Access denied");
                    return;
                }

                document.getElementById("loginBtn").disabled = true;
                document.getElementById("loginBtn").innerText = "Logged in";

                loadData();
            } catch (err) {
                console.error(err);
                alert("Login failed");
            }
        };

        /* ---------- LOAD DATA (NEWEST FIRST) ---------- */
        async function loadData() {
            const tbody = document.getElementById("tbody");
            tbody.innerHTML = "";

            const q = query(
                collection(db, "quiz_users"),
                orderBy("submittedAt", "desc")
            );

            const snapshot = await getDocs(q);
            let index = 1;

            snapshot.forEach(docSnap => {
                const d = docSnap.data();
                const rawScores = d.scores || {};

                const scores = {
                    Circle: rawScores.Circle ?? rawScores.circle ?? 0,
                    Diamond: rawScores.Diamond ?? rawScores.diamond ?? 0,
                    Rectangle: rawScores.Rectangle ?? rawScores.rectangle ?? 0,
                    Square: rawScores.Square ?? rawScores.square ?? 0,
                    Star: rawScores.Star ?? rawScores.star ?? 0,
                    Triangle: rawScores.Triangle ?? rawScores.triangle ?? 0
                };

                tbody.innerHTML += `
            <tr>
                <td>${index++}</td>
                <td>${d.name || "-"}</td>
                <td>${d.countryCode || ""}${d.whatsapp || "-"}</td>
                <td>${d.submittedAt?.toDate().toLocaleString() || "-"}</td>

                <td>${scores.Circle}</td>
                <td>${scores.Diamond}</td>
                <td>${scores.Rectangle}</td>
                <td>${scores.Square}</td>
                <td>${scores.Star}</td>
                <td>${scores.Triangle}</td>
            </tr>
        `;
            });

            document.getElementById("tableWrapper").style.display = "block";
            document.getElementById("exportBtn").style.display = "inline-block";
        }


        /* ---------- EXPORT CSV ---------- */
        window.exportCSV = () => {

            let csv = "Name,WhatsApp,Submitted At,Circle,Diamond,Rectangle,Square,Star,Triangle\n";

            document.querySelectorAll("#tbody tr").forEach(row => {
                const cols = row.querySelectorAll("td");

                const rowData = [
                    cols[1].innerText.replace(/\t/g, " ").trim(),
                    cols[2].innerText.replace(/\t/g, " ").trim(),
                    cols[3].innerText.replace(/\t/g, " ").trim(),
                    cols[4].innerText.replace(/\t/g, " ").trim(),
                    cols[5].innerText.replace(/\t/g, " ").trim(),
                    cols[6].innerText.replace(/\t/g, " ").trim(),
                    cols[7].innerText.replace(/\t/g, " ").trim(),
                    cols[8].innerText.replace(/\t/g, " ").trim(),
                    cols[9].innerText.replace(/\t/g, " ").trim()
                ];

                csv += rowData
                    .map(value => `"${value.replace(/"/g, '""')}"`)
                    .join(",") + "\n";
            });

            const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });

            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "quiz_users_with_scores.csv";
            link.click();
        };
    </script>

</body>

</html>